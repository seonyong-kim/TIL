# Virtual Memory

## Motivation of Virtual Memory
- ì½”ë“œì™€ ë°ì´í„°ëŠ” ì‹¤í–‰ì„ ìœ„í•´ ë©”ëª¨ë¦¬ì— ìˆì–´ì•¼ í•˜ì§€ë§Œ, ì „ì²´ í”„ë¡œê·¸ë¨ì´ ëª¨ë‘ ì‚¬ìš©ë˜ëŠ” ê²½ìš°ëŠ” ì ë‹¤.
  - ì˜ˆ: ì˜¤ë¥˜ ì½”ë“œ, íŠ¹ì´í•œ ë£¨í‹´, ëŒ€í˜• ë°ì´í„° êµ¬ì¡° ë“± ì–´ë–¤ ì½”ë“œëŠ” ì•ˆ ë‹¤ë£¨ê¸°ë„ í•œë‹¤.
- ë¶€ë¶„ì ìœ¼ë¡œë§Œ ì ì¬ëœ í”„ë¡œê·¸ë¨(partially-loaded program)ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ê³ ë ¤
  - í”„ë¡œê·¸ë¨ì´ ë” ì´ìƒ ë¬¼ë¦¬ì  ë©”ëª¨ë¦¬(physical memory)ì˜ í•œê³„ì— ì œì•½ë°›ì§€ ì•ŠëŠ”ë‹¤. -> ì œì•½ X
  - ì‹¤í–‰ ì¤‘ì¸ ê° í”„ë¡œê·¸ë¨ì´ ì°¨ì§€í•˜ëŠ” ë©”ëª¨ë¦¬ ê³µê°„ì´ ì¤„ì–´ë“ ë‹¤. -> ë”°ë¼ì„œ ë™ì‹œì— ë” ë§ì€ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤. degree of multiprograming ì¦ê°€.
    - ì´ì— ë”°ë¼ CPU í™œìš©ë¥ (CPU utilization)ê³¼ ì²˜ë¦¬ëŸ‰(throughput)ì´ ì¦ê°€í•˜ì§€ë§Œ, ì‘ë‹µ ì‹œê°„(response time)ì´ë‚˜ ë°˜í™˜ ì‹œê°„(turnaround time)ì€ ì¦ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤.
  - í”„ë¡œê·¸ë¨ì„ ë©”ëª¨ë¦¬ì— ì ì¬í•˜ê±°ë‚˜ ìŠ¤ì™€í•‘í•  ë•Œ í•„ìš”í•œ I/Oê°€ ì¤„ì–´ë“ ë‹¤. -> ê° ì‚¬ìš©ì í”„ë¡œê·¸ë¨ì´ ë” ë¹¨ë¦¬ ì‹¤í–‰ë¨
- ì´ëŸ¬í•œ ì¥ì ë•Œë¬¸ì— virtual memory ì‹œì‘

## Virtual Memory
- ì‚¬ìš©ì ë…¼ë¦¬ ë©”ëª¨ë¦¬(user logical memory)ì™€ ë¬¼ë¦¬ ë©”ëª¨ë¦¬(physical memory)ë¥¼ ë¶„ë¦¬í•œë‹¤.
  - ì‹¤í–‰ì„ ìœ„í•´ í”„ë¡œê·¸ë¨ì˜ ì¼ë¶€ë§Œ ë©”ëª¨ë¦¬ì— ìˆìœ¼ë©´ ëœë‹¤.
  - ë”°ë¼ì„œ Logical address spaceëŠ” physical address spaceë³´ë‹¤ í›¨ì”¬ í´ ìˆ˜ ìˆìŒ
  - ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ì£¼ì†Œ ê³µê°„(address spaces)ì„ ê³µìœ í•  ìˆ˜ ìˆë‹¤.
    - ë” íš¨ìœ¨ì ì¸ í”„ë¡œì„¸ìŠ¤ ìƒì„±ì´ ê°€ëŠ¥í•˜ë‹¤.
    - ë™ì‹œì— ë” ë§ì€ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ê°€ëŠ¥
    - Less I/O needed to load or swap processes
- ê°€ìƒ ì£¼ì†Œ ê³µê°„(Virtual address space): í”„ë¡œì„¸ìŠ¤ê°€ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ëŠ” ë…¼ë¦¬ì ì¸ ê´€ì 
  - ë³´í†µ ì£¼ì†Œ 0ë¶€í„° ì‹œì‘í•˜ë©°, ê³µê°„ì˜ ëê¹Œì§€ ì—°ì†ì ì¸ ì£¼ì†Œ ì‚¬ìš©
  - ë°˜ë©´, ë¬¼ë¦¬ ë©”ëª¨ë¦¬ëŠ” page frames ë‹¨ìœ„ë¡œ êµ¬ì„±ë¨
  - MMU(Memory Management Unit)ëŠ” ë…¼ë¦¬ ì£¼ì†Œë¥¼ ë¬¼ë¦¬ ì£¼ì†Œë¡œ ë§¤í•‘í•´ì•¼ í•¨
- Virtual memoryëŠ” ë‹¤ìŒ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥
  - Demand paging
  - Demand segmentation

## Virtual Memory(2)
- Virtual memoryëŠ” physical memoryë³´ë‹¤ ë” í¬ë‹¤ <br>

![image](https://github.com/user-attachments/assets/0805e26e-4b0c-4dea-8526-e2e37495d5d7) <br>

- Virtual address space
  - Contiguous memory space 0 to max (code to stack)
  - Unused address space between stack and heap
  - System libraries shared via mapping into virtual address space
  - Shared memory by mapping pages read-write into virtual address space
  - Pages can be shared during fork(), speeding process creation
  - 0ë¶€í„° ìµœëŒ€ì¹˜ê¹Œì§€ ì—°ì†ì ì¸ ë©”ëª¨ë¦¬ ê³µê°„ (ì½”ë“œë¶€í„° ìŠ¤íƒê¹Œì§€)
  - ìŠ¤íƒê³¼ í™ ì‚¬ì´ì—ëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ì£¼ì†Œ ê³µê°„ ì¡´ì¬
  - ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê°€ìƒ ì£¼ì†Œ ê³µê°„ì— ë§¤í•‘í•˜ì—¬ ê³µìœ ë¨
  - ê³µìœ  ë©”ëª¨ë¦¬ëŠ” í˜ì´ì§€ë¥¼ read-write ê¶Œí•œìœ¼ë¡œ ê°€ìƒ ì£¼ì†Œ ê³µê°„ì— ë§¤í•‘í•¨ìœ¼ë¡œì¨ ê°€ëŠ¥í•˜ë‹¤.
  - fork() ì¤‘ì— í˜ì´ì§€ë¥¼ ê³µìœ í•¨ìœ¼ë¡œì¨ í”„ë¡œì„¸ìŠ¤ ìƒì„± ì†ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŒ <br>

![image](https://github.com/user-attachments/assets/3c59ae3e-0fde-4d80-997f-f9cb9b568dd0)
- Shared library using virtual memory <br>

![image](https://github.com/user-attachments/assets/aee7af08-6638-44cd-a793-62bc28f7867d)

# Demand Paging
## Basic Concept of Demand Paging
- í˜ì´ì§€ë¥¼ ë©”ëª¨ë¦¬ì— ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒì€ í•„ìš”í•  ë•Œë§Œ ìˆ˜í–‰
  - ë” ì ì€ I/O í•„ìš”, ë¶ˆí•„ìš”í•œ I/O ì—†ë‹¤
  - ë” ì ì€ ë©”ëª¨ë¦¬ í•„ìš”
  - ë” ë¹ ë¥¸ ì‘ë‹µ ì†ë„
  - ë” ë§ì€ ì‚¬ìš©ì ê°€ëŠ¥
- ìŠ¤ì™€í•‘(swapping)ì´ ìˆëŠ” í˜ì´ì§• ì‹œìŠ¤í…œ(paging system)ê³¼ ìœ ì‚¬
- í˜ì´ì§€ê°€ í•„ìš”í•  ê²½ìš° â†’ í•´ë‹¹ í˜ì´ì§€ì— ëŒ€í•œ ì°¸ì¡° ë°œìƒ
  - ì˜ëª»ëœ ì°¸ì¡°(ì°¸ì¡°ë¥¼ í•´ë„ ë˜ëŠ” ë¶€ë¶„ì„ ì°¸ì¡°í•˜ëŠ”ì§€ í™•ì¸) â†’ ì¤‘ë‹¨
  - ë©”ëª¨ë¦¬ì— ì—†ìŒ â†’ ë©”ëª¨ë¦¬ë¡œ ë¶ˆëŸ¬ì˜´
- Lazy swapper: í˜ì´ì§€ê°€ í•„ìš”í•  ë•Œë§Œ ë©”ëª¨ë¦¬ì— ìŠ¤ì™€í•‘
  - í˜ì´ì§€ë¥¼ ë‹¤ë£¨ëŠ” swapperëŠ” pagerë¼ê³  í•¨<br>
 
![image](https://github.com/user-attachments/assets/63bc860c-5262-491b-9ea5-50c15bede2f0) <br>
- demand pagingì„ êµ¬í˜„í•˜ë ¤ë©´ ìƒˆë¡œìš´ MMU ê¸°ëŠ¥ì´ í•„ìš”í•˜ë‹¤ -> ì¶”ê°€ì ìœ¼ë¡œ ì£¼ì†Œë³€í™˜ + memoryì— ìˆëŠ”ì§€ check
- í•„ìš”í•œ í˜ì´ì§€ê°€ ì´ë¯¸ ë©”ëª¨ë¦¬ì— ìƒì£¼í•´ ìˆë‹¤ë©´
  - non demand-paging ê²½ìš°ì™€ ì°¨ì´ ì—†ë‹¤
- í•„ìš”í•œ í˜ì´ì§€ê°€ ë©”ëª¨ë¦¬ì— ì—†ì„ ê²½ìš°
  - í˜ì´ì§€ê°€ í•„ìš”í•œ ê²ƒì„ ê°ì§€í•˜ê³  ì €ì¥ì¥ì¹˜(storage)ì—ì„œ ë©”ëª¨ë¦¬ë¡œ ë¡œë“œí•´ì•¼ í•œë‹¤. -> storageì–´ë””ì— ìˆëŠ”ì§€ check
    - í”„ë¡œê·¸ë¨ ë™ì‘ì„ ë³€ê²½í•˜ì§€ ì•Šê³ 
    - í”„ë¡œê·¸ë˜ë¨¸ê°€ ì½”ë“œë¥¼ ë³€ê²½í•  í•„ìš” ì—†ì´

## Valid-Invalid Bit -> memoryì— ìˆëŠ”ì§€ check
- ê° í˜ì´ì§€ í…Œì´ë¸” í•­ëª©ì—ëŠ” valid-invalid bitê°€ ì—°ê²°ë˜ì–´ ìˆë‹¤.
  - v â†’ ë©”ëª¨ë¦¬ì— ìˆìŒ (memory resident)
  - i â†’ ë©”ëª¨ë¦¬ì— ì—†ìŒ
- ì´ˆê¸°ì—ëŠ” ëª¨ë“  í•­ëª©ì˜ valid-invalid bitë¥¼ ië¡œ ì„¤ì •í•œë‹¤.
- í˜ì´ì§€ í…Œì´ë¸” ìŠ¤ëƒ…ìƒ· ì˜ˆì‹œ: <br>

![image](https://github.com/user-attachments/assets/e8e2d393-cf88-492f-ba67-f42fec4717d2)<br>
- MMUê°€ ì£¼ì†Œ ë³€í™˜ì„ ìˆ˜í–‰í•˜ëŠ” ë™ì•ˆ, valid-invalid bitê°€ i(invalid)ì´ë©´ â†’ í˜ì´ì§€ í´íŠ¸(page fault) ë°œìƒ(page faultë¼ëŠ” trapì„ ë„ìš´ë‹¤)

## Page Table Example
![image](https://github.com/user-attachments/assets/fb47ca61-2fc3-4767-a75f-54971ee782bd)

## Page Fault -> page ì ‘ê·¼ì‹œ í•´ë‹¹ pageì—†ë‹¤(ì²«ë²ˆì§¸ ì ‘ê·¼)
- í˜ì´ì§€ì— ëŒ€í•œ ì°¸ì¡°ê°€ ìˆì„ ë•Œ, í•´ë‹¹ í˜ì´ì§€ì— ëŒ€í•œ ì²« ë²ˆì§¸ ì°¸ì¡°(ì ‘ê·¼í•´ë„ ë˜ëŠ” ì£¼ì†Œì¸ì§€ í™•ì¸)ëŠ” ìš´ì˜ì²´ì œë¡œ trap(í˜ì´ì§€ í´íŠ¸)ëœë‹¤.
1. ìš´ì˜ì²´ì œëŠ” ë‹¤ë¥¸ í…Œì´ë¸”ì„ í™•ì¸í•˜ì—¬ ê²°ì •í•œë‹¤:
  - ì˜ëª»ëœ ì°¸ì¡° â†’ ì¤‘ë‹¨(abort) -> ë
  - ë‹¨ì§€ ë©”ëª¨ë¦¬ì— ì—†ë‹¤. -> 2ë²ˆìœ¼ë¡œ
2. ë¹ˆ í”„ë ˆì„(free frame) ì°¾ê¸° -> ë¹ˆ frame ì°¾ê¸°(ë¹ˆì¹¸ì´ ìˆë‹¤ ê°€ì •)
3. ì˜ˆì•½ëœ ë””ìŠ¤í¬ ì‘ì—…(scheduled disk operation)ì„ í†µí•´ í˜ì´ì§€ë¥¼ í”„ë ˆì„ìœ¼ë¡œ êµì²´(Swap)í•œë‹¤.
4. í˜ì´ì§€ê°€ í˜„ì¬ ë©”ëª¨ë¦¬ì— ìˆìŒì„ ë‚˜íƒ€ë‚´ë„ë¡ í…Œì´ë¸”ì„ ì¬ì„¤ì •í•˜ê³  valid-invalid bit = vë¡œ ì„¤ì •
5. í˜ì´ì§€ í´íŠ¸( page fault)ë¥¼ ë°œìƒì‹œí‚¨ ëª…ë ¹ì–´ ì¬ì‹œì‘ -> page fault ì•¼ê¸°í•œ instruction ì €ëŒ€ë¡œ ìˆ˜í–‰X -> ë‹¤ì‹œ ì²˜ìŒë¶€í„° ì‹œì‘í•œë‹¤. <br>

![image](https://github.com/user-attachments/assets/945a525f-da2c-4edf-a32a-8293cff1b9cc)

## Characteristics of Demand Paging
- Pure demand paging: í”„ë¡œì„¸ìŠ¤ë¥¼ ë©”ëª¨ë¦¬ì— ì•„ë¬´ í˜ì´ì§€ë„ ì—†ëŠ” ìƒíƒœì—ì„œ ì‹œì‘í•œë‹¤.
  - ìš´ì˜ì²´ì œê°€ í”„ë¡œì„¸ìŠ¤ì˜ ì²« ë²ˆì§¸ ëª…ë ¹ì–´ë¡œ ëª…ë ¹ì–´ í¬ì¸í„°ë¥¼ ì„¤ì • í›„ í•´ë‹¹ ëª…ë ¹ì–´ê°€ ë©”ëª¨ë¦¬ì— ì—†ìœ¼ë©´ â†’ page fault ë°œìƒ
  - ê·¸ë¦¬ê³  ë‹¤ë¥¸ ëª¨ë“  í”„ë¡œì„¸ìŠ¤ í˜ì´ì§€ë“¤ë„ ì²« ì ‘ê·¼ ì‹œë§ˆë‹¤ ë°œìƒ
- ì‹¤ì œë¡œ, íŠ¹ì • ëª…ë ¹ì–´ëŠ” ì—¬ëŸ¬ í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ â†’ ì—¬ëŸ¬ ê°œì˜ í˜ì´ì§€ í´íŠ¸ ë°œìƒ ê°€ëŠ¥
  - ì˜ˆ: ë‘ ê°œì˜ ë©”ëª¨ë¦¬ ìˆ«ìë¥¼ ë”í•˜ê³  ê²°ê³¼ë¥¼ ë‹¤ì‹œ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ëŠ” ëª…ë ¹ì–´ì˜ ê°€ì ¸ì˜¤ê¸°(fetch)ì™€ ë””ì½”ë”©(decode) ê³¼ì •
  - ì°¸ì¡° ì§€ì—­ì„±(locality of reference) ë•Œë¬¸ì— ì´ëŸ° ê³ í†µì€ ê°ì†Œ -> ë§¤ë²ˆ page fault ì•¼ê¸°ëŠ” ë“œë¬¼ë‹¤.
- demand pagingì„ ìœ„í•œ í•˜ë“œì›¨ì–´ ì§€ì› í•„ìš”
  - valid / invalid bitë¥¼ ê°€ì§„ Page table (MMU)
  - ë³´ì¡° ê¸°ì–µì¥ì¹˜(Secondary memory) (ìŠ¤ì™‘ ì¥ì¹˜) -> backing store
  - ëª…ë ¹ì–´ ì¬ì‹œì‘

## Instruction Restart
- í”„ë¡œì„¸ìŠ¤ë¥¼ ê³„ì† ì‹¤í–‰í•˜ëŠ” ê²ƒì€ ë§¤ìš° ê¹Œë‹¤ë¡­ë‹¤. ì™œëƒí•˜ë©´ page faultê°€ ëª…ë ¹ì–´ ìˆ˜í–‰ ì¤‘ê°„ì— ë°œìƒí–ˆì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
  - ì‚¬ìš©ì í”„ë¡œì„¸ìŠ¤ëŠ” page faultê°€ ë°œìƒí–ˆë‹¤ëŠ” ì‚¬ì‹¤ì¡°ì°¨ ëª°ë¼ì•¼ í•œë‹¤.
  - ëª…ë ¹ì–´ë¥¼ ê·¸ëƒ¥ ê±´ë„ˆë›¸ ìˆ˜ ìˆì„ê¹Œ?
    - NO: í”„ë¡œì„¸ìŠ¤ê°€ ê·¸ ë³€í™”ë¥¼ ì¸ì§€í•˜ê²Œ ëœë‹¤
  - ëª…ë ¹ì–´ë¥¼ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ì•¼ í•œë‹¤.
    - ìë™ ì¦ê°€/ê°ì†Œ(auto increment/decrement) ê°™ì€ ëª…ë ¹ì–´ëŠ” ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?
  - ëª…ë ¹ì–´ë¥¼ ì¬ì‹œì‘í•˜ê¸° ìœ„í•œ í•˜ë“œì›¨ì–´ ì§€ì›ì´ í•„ìš”í•˜ë‹¤.
 
## TLB Fault vs. Page Fault
- ë©”ëª¨ë¦¬ ê´€ë ¨ ì˜¤ë¥˜ì—ëŠ” ë‘ ê°€ì§€ê°€ ìˆë‹¤:
  - TLB fault (TLB ì˜¤ë¥˜)
    - í•„ìš”í•œ ê°€ìƒ â†’ ë¬¼ë¦¬ ì£¼ì†Œ ë³€í™˜ ì •ë³´ê°€ TLBì— ì—†ë‹¤
  - Page fault (í˜ì´ì§€ í´íŠ¸)
    - ê°€ìƒ í˜ì´ì§€ì˜ ë‚´ìš©ì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë©”ëª¨ë¦¬ì— ì—†ìŒ
- ì¤‘ìš”í•œ ì‚¬ì‹¤ë“¤:
  - ëª¨ë“  Page faultëŠ” TLB faultë³´ë‹¤ ë’¤ì— ë°œìƒí•œë‹¤
    - ê°€ìƒ í˜ì´ì§€ì˜ ë‚´ìš©ì´ ë©”ëª¨ë¦¬ì— ì—†ë‹¤ë©´, ê·¸ì— ëŒ€í•œ ë³€í™˜ ì •ë³´(TLB ì—”íŠ¸ë¦¬)ëŠ” ì¡´ì¬í•  ìˆ˜ ì—†ë‹¤
  - ëª¨ë“  TLB faultê°€ Page faultë¥¼ ìœ ë°œí•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤
    - í˜ì´ì§€ê°€ ë©”ëª¨ë¦¬ì— ìˆê³ , ë³€í™˜ ì •ë³´ê°€ í˜ì´ì§€ í…Œì´ë¸”ì— ìˆë‹¤ë©´ â†’ TLBì— ë‹¤ì‹œ ì±„ì›Œ ë„£ìŒìœ¼ë¡œì¨ page fault ì—†ì´ ì²˜ë¦¬ ê°€ëŠ¥ <br>

![image](https://github.com/user-attachments/assets/9430a5de-a2a6-4dea-a40a-3154036be8d6)

## Stages in Demand Paging -> page fault ì¼ì–´ë‚œ ì§í›„
1. OSë¡œ Trap ë°œìƒ
2. user registersì™€ process state ì €ì¥ -> page fault handler ëˆë‹¤.
3. interruptê°€ page faultì˜€ëŠ”ì§€ í™•ì¸
4. í˜ì´ì§€ ì°¸ì¡°ê°€ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³  ë””ìŠ¤í¬ì—ì„œ í˜ì´ì§€ ìœ„ì¹˜ í™•ì¸
5. ë””ìŠ¤í¬ì—ì„œ free frameìœ¼ë¡œ ì½ê¸° ìš”ì²­ -> diskë¡œ ë¶€í„° í•˜ë‚˜ ê°€ì ¸ì˜¨ë‹¤.
   - 1. ì´ ì¥ì¹˜ì˜ ì½ê¸° ìš”ì²­ì´ ì²˜ë¦¬ë  ë•Œê¹Œì§€ ëŒ€ê¸°ì—´ì—ì„œ ê¸°ë‹¤ë¦°ë‹¤.
   - 2. ì¥ì¹˜ íƒìƒ‰ ì‹œê°„ ë°/ë˜ëŠ” ì§€ì—° ì‹œê°„ì„ ê¸°ë‹¤ë¦°ë‹¤.
   - 3. í˜ì´ì§€ë¥¼ ë¹ˆ í”„ë ˆì„(free frame)ìœ¼ë¡œ ì „ì†¡í•˜ê¸° ì‹œì‘í•œë‹¤.
6. ëŒ€ê¸° ì¤‘ì—ëŠ” CPUë¥¼ ë‹¤ë¥¸ ì‚¬ìš©ì(í”„ë¡œì„¸ìŠ¤)ì—ê²Œ í• ë‹¹
7. ë””ìŠ¤í¬ I/O ì„œë¸Œì‹œìŠ¤í…œ(disk I/O subsystem)ìœ¼ë¡œë¶€í„° ì¸í„°ëŸ½íŠ¸(interrupt) ìˆ˜ì‹  (I/O ì™„ë£Œë¨)
8. other user(í”„ë¡œì„¸ìŠ¤)ì˜ ë ˆì§€ìŠ¤í„°ì™€ ìƒíƒœ ì €ì¥ -> ë°±ì—…
9. interruptê°€ diskë¡œë¶€í„° ì™”ëŠ”ì§€ í™•ì¸
10. í˜ì´ì§€ê°€ ì´ì œ ë©”ëª¨ë¦¬ì— ìˆìŒì„ ë‚˜íƒ€ë‚´ë„ë¡ í˜ì´ì§€ í…Œì´ë¸” ë° ê¸°íƒ€ í…Œì´ë¸” ìˆ˜ì •
10-2. ready queueì— pqge fault ì•¼ê¸°í•œ process ë„£ì–´ì¤€ë‹¤.
11. ì´ í”„ë¡œì„¸ìŠ¤ì— ë‹¤ì‹œ CPUê°€ í• ë‹¹ë  ë•Œê¹Œì§€ ëŒ€ê¸°
12. user registers, process state, new page table ë³µì› í›„, interruptedë¤ ëª…ë ¹ì–´ ì¬ê°œ

## Performance of Demand Paging (1)
- ì„¸ ê°€ì§€ ì£¼ìš” ë™ì‘
  - ì¸í„°ëŸ½íŠ¸ ì²˜ë¦¬(Service the interrupt): ì‹ ì¤‘í•œ ì½”ë”© ë•ë¶„ì— ìˆ˜ë°± ê°œì˜ ëª…ë ¹ì–´ë§Œ í•„ìš”
  - Read the page and write the victim(êµì²´) page (swap): ë§ì€ ì‹œê°„ì´ ì†Œìš”ë¨ -> ì œì¼ ì˜¤ë˜ ê±¸ë¦¼
  - Restart the process: ë‹¤ì‹œ ì†ŒëŸ‰ì˜ ì‹œê°„ë§Œ í•„ìš” 
- Page fault rate (p): 0 â‰¤ ğ‘ â‰¤ 1 -> ë©”ëª¨ë¦¬ì ‘ê·¼ë‹¹ page fault ë¹„ìœ¨
  - if p = 0: page faults ì—†ë‹¤.
  - if p = 1: ë§¤ë²ˆ ì°¸ì¡°ê°€ fault
- Effective Access Time (EAT)
  - EAT = (1-p) * memory access time(page hitì¸ ê²½ìš° access time) + p * (page fault overhead + swap page out + swap page in) <br>
  swap page out + swap page inì´ê²Œ ì»¤ì„œ ë¬»íŒë‹¤.
- Example
  - Memory access time = 100 ns
  - Average page-fault service time = 8 ms (page fault overhead + swap in/out time)
  - EAT = (1-p)*100 + p * 8,000,000 = 100 + p * 7,999,900

- In this case, if one access out of 1,000 causes a page fault (p = 0.001), then
  - EAT = 8.1us -> 1000ë²ˆì¤‘ 1ë²ˆì´ì—¬ë„ í‰ê· ì ìœ¼ë¡œ 80ë°° ì¦ê°€í•œë‹¤

- ì„±ëŠ¥ ì €í•˜ë¥¼ 10% ë¯¸ë§Œìœ¼ë¡œ ì›í•œë‹¤ë©´ (EAT < 110 ns)
  - 110 > 100 + p * 7,999,900 <br>
  -> 10 > p * 7,999,900 <br>
  -> p < 0.00000125 <br>
  - one page fault in every 800,000 memory access -> page fault ì˜ ì¼ì–´ë‚˜ë©´ ì•ˆëœë‹¤.

# Page Selection
## Key Issues in Demand Paging
- Page selection -> ì–´ë–¤ page ì–¸ì œ?
- Page replacement -> ì–´ë–¤ page out?
- Page frame allocation -> ê· ë“± or ë…ì ?

## Page Selection
- Page selection policies
  - Demand paging
    - process ì‹œì‘ ì‹œ ì–´ë–¤ í˜ì´ì§€ë„ ë¡œë“œí•˜ì§€ ì•ŠìŒ
    - í•´ë‹¹ í˜ì´ì§€ì— ëŒ€í•œ page faultê°€ ë°œìƒí–ˆì„ ë•Œ ë¡œë“œ
      - ë°˜ë“œì‹œ memoryì— ìˆì–´ì•¼ í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤.
    - Almost all paging systemsì´ ì´ë ‡ê²Œ ë™ì‘í•¨
  - Prepaging
    - ì°¸ì¡°ë˜ê¸° ì „ì— pageë¥¼ memoryì— ê°€ì ¸ì˜´
    - ì–´ë–¤ pageê°€ ì°¸ì¡°ë˜ë©´, í˜¹ì‹œ ëª°ë¼ ê·¸ ë‹¤ìŒ í˜ì´ì§€ë„ ê°€ì ¸ì˜´
    - ì˜ˆì–¸ì´ ì—†ëŠ” ì´ìƒ íš¨ê³¼ì ìœ¼ë¡œ í•˜ê¸° ì–´ë ¤ì›€
    - ê°€ë”ì€ íš¨ê³¼ ìˆìŒ: ìˆœì°¨ì  ì½ê¸° ì˜ˆì¸¡(sequential read-ahead)
  - Request paging
    - userê°€ ì–´ë–¤ pagesê°€ í•„ìš”í•œì§€ ë§í•˜ê²Œ í•œë‹¤.
    - ì´ ë°©ì‹ì˜ ë¬¸ì œëŠ”
    - Usersê°€ í•­ìƒ ìµœì„ ì˜ ì„ íƒì„ í•˜ì§€ ì•Šìœ¼ë©°, ê³µì •í•˜ì§€ ì•Šë‹¤.
  - Copy-on-Write(COW, ì“°ê¸° ì‹œ ë³µì‚¬)ëŠ” parentì™€ child processesê°€ ì²˜ìŒì—ëŠ” ë™ì¼í•œ memory pagesë¥¼ ê³µìœ í•˜ë„ë¡ í—ˆìš©í•œë‹¤.
    - ë‘ process ì¤‘ í•˜ë‚˜ë¼ë„ shared pageë¥¼ ìˆ˜ì •í•˜ë©´, ê·¸ë•Œì„œì•¼ í•´ë‹¹ pageê°€ ë³µì‚¬ëœë‹¤.
  - COWëŠ” modified pagesë§Œ ë³µì‚¬í•˜ë¯€ë¡œ, í”„ë¡œì„¸ìŠ¤ë¥¼ ë” íš¨ìœ¨ì ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.
  - ì¼ë°˜ì ìœ¼ë¡œ, free pagesëŠ” 'ìš”ì²­ ì‹œ 0ìœ¼ë¡œ ì±„ì›Œì§€ëŠ”(zero-fill-on-demand, OSê°€ ê´€ë¦¬)' í˜ì´ì§€ í’€ì—ì„œ í• ë‹¹ëœë‹¤.
    - ë¹ ë¥¸ ìš”ì²­ í˜ì´ì§•ì„ ìœ„í•´ ì´ í’€ì—ëŠ” í•­ìƒ ì—¬ìœ  í”„ë ˆì„ì´ ìˆì–´ì•¼ í•¨
      - í˜ì´ì§€ í´íŠ¸ ì‹œ í”„ë ˆì„ì„ í•´ì œí•˜ê³  ë‹¤ë¥¸ ì²˜ë¦¬ë¥¼ ë™ì‹œì— í•˜ê²Œ í•˜ê³  ì‹¶ì§„ ì•Šë‹¤.
    - í˜ì´ì§€ë¥¼ í• ë‹¹í•˜ê¸° ì „ì— 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ëŠ” ì´ìœ ëŠ”? <br>
    -> ì´ì „ processê°€ ì‚¬ìš©í•˜ë˜ ì›ë˜ dataê°€ ë‚¨ì´ìˆëŠ”ë° ì „ë¶€ ë®ì–´ì“°ëŠ”ê²Œ ì•„ë‹ˆë¼ë©´ ì´ì „ processê°€ ì‚¬ìš©í•˜ë˜ ì¼ë¶€ dataê°€ ë‚¨ëŠ”ë‹¤ <br>
    -> ë³´ì•ˆë¬¸ì œ ë°œìƒ
  - vfork()ëŠ” fork() system callì˜ ë³€í˜•ìœ¼ë¡œ, ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¼ì‹œ ì¤‘ë‹¨í•˜ê³  ìì‹ì´ ë¶€ëª¨ì˜ ì£¼ì†Œ ê³µê°„(COW ë°©ì‹)ì„ ì‚¬ìš©í•œë‹¤.
    - ìì‹ í”„ë¡œì„¸ìŠ¤ê°€ exec()ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆë‹¤.
    - ë§¤ìš° íš¨ìœ¨ì ì´ë‹¤.<br>

![image](https://github.com/user-attachments/assets/2363a314-07e3-46de-b80a-8f24a5e90013)<br>
![image](https://github.com/user-attachments/assets/fb80ea6a-2afa-40a3-b338-b2d57e7e73e0)

## Page Replacement
- Page replacement â€“ memoryì— ìˆì§€ë§Œ ì‹¤ì œë¡œ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” í˜ì´ì§€ë¥¼ ì°¾ì•„ì„œ page it outí•œë‹¤.
  1. diskì—ì„œ ì›í•˜ëŠ” í˜ì´ì§€ì˜ ìœ„ì¹˜ë¥¼ ì°¾ëŠ”ë‹¤.
  2. free frameì„ ì°¾ëŠ”ë‹¤.
     - free frameì´ ìˆë‹¤ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
     - free frameì´ ì—†ë‹¤ë©´, page replacement algorithmì„ ì‚¬ìš©í•´ victim frameì„ ì„ íƒ
       - victim frameì´ dirty(ìˆ˜ì •ëœ ìƒíƒœ)ë¼ë©´ diskì— ì €ì¥í•œë‹¤. <br>
       ìˆ˜ì •ëœì ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë²„ë ¤ë„ ëœë‹¤.(diskì— ì›ë³¸ dataê°€ ìˆì–´ì„œ)
  3. ì›í•˜ëŠ” í˜ì´ì§€ë¥¼ (ìƒˆë¡­ê²Œ) free frameì— ê°€ì ¸ì˜¨ë‹¤. page and frame tablesì„ ê°±ì‹ í•œë‹¤.
  4. íŠ¸ë©(trap)ì„ ë°œìƒì‹œí‚¨ ëª…ë ¹ì–´ë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ë©´ì„œ í”„ë¡œì„¸ìŠ¤ë¥¼ ê³„ì† ì§„í–‰
  - ì£¼ì˜: page faultì‹œ ìµœëŒ€ 2ë²ˆì˜ í˜ì´ì§€ ì „ì†¡(page-in, page-out)ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ â†’ ìœ íš¨ ì ‘ê·¼ ì‹œê°„(EAT)ì´ ì¦ê°€í•¨<br>

![image](https://github.com/user-attachments/assets/ff61466b-0097-406a-8d8a-5a20094d6d13)

## Page Replacement Algorithms (1)
 â€¢ Page replacement algorithms
 â€¢ Want lowest page-fault rate on both first access and re-access
 â€¢ Evaluate algorithm by running it on a particular string of memory references 
(reference string) and computing the number of page faults on that string
 â€¢ String is just page numbers, not full addresses
 â€¢ Repeated access to the same page does not cause a page fault
 â€¢ Results depend on number of frames available
 â€¢ In all our examples, the reference string of referenced page number is
 â€¢ 7, 0, 1, 2, 0, 3, 0, 4, 2, 3, 0, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1

- Page replacement algorithms
  - first access and re-access ëª¨ë‘ì—ì„œ page-fault rateì´ ê°€ì¥ ë‚®ê¸°ë¥¼ ì›í•œë‹¤.
- algorithm í‰ê°€í•  ë•ŒëŠ” íŠ¹ì •í•œ ë©”ëª¨ë¦¬ ì°¸ì¡° ë¬¸ìì—´(reference string)ì„ ì‚¬ìš©í•´ number of page faults on that stringë¥¼ ê³„ì‚°í•œë‹¤.
  - ì´ ë¬¸ìì—´ì€ full addressesê°€ ì•„ë‹Œ page numbersë§Œ í¬í•¨í•œë‹¤.
  - ë™ì¼í•œ í˜ì´ì§€ë¥¼ ë°˜ë³µí•´ì„œ ì ‘ê·¼í•´ë„ page faultëŠ” ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.
  - ê²°ê³¼ëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ frames ìˆ˜ì— ë”°ë¼ ë‹¬ë¼ì§„ë‹¤.
- ìš°ë¦¬ê°€ ì˜ˆì œë¡œ ì‚¬ìš©í•  ì°¸ì¡° ë¬¸ìì—´(reference string)ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:
  - 7, 0, 1, 2, 0, 3, 0, 4, 2, 3, 0, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1
- Random: ì„ì˜ì˜ í˜ì´ì§€ë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ íƒí•´ êµì²´í•œë‹¤.
  - ë†€ëê²Œë„ ê½¤ ì˜ ì‘ë™í•œë‹¤!
- FIFO(First-In, First-Out): ë©”ëª¨ë¦¬ì— ê°€ì¥ ì˜¤ë˜ ìˆì—ˆë˜ í˜ì´ì§€ë¥¼ ì œê±°
  - ê³µì •ì„±ì„ ìœ„í•œ ì•„ì´ë””ì–´
  - ëª¨ë“  í˜ì´ì§€ì—ê²Œ ë™ì¼í•œ ì²´ë¥˜ ì‹œê°„ì„ ì¤€ë‹¤.
- OPT(Optimal): ì•ìœ¼ë¡œ ê°€ì¥ ì˜¤ë«ë™ì•ˆ ì‚¬ìš©ë˜ì§€ ì•Šì„ í˜ì´ì§€ë¥¼ ì œê±°
  - ì–¸ì œë‚˜ ê·¸ë ‡ë“¯, ë¯¸ë˜ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ìˆë‹¤ë©´ ê°€ì¥ ì¢‹ì€ ì•Œê³ ë¦¬ì¦˜ì´ ë¨
  - ì‹¤ì œë¡œ êµ¬í˜„í•˜ê¸°ëŠ” ì–´ë µì§€ë§Œ, ë¹„êµ ê¸°ì¤€ìœ¼ë¡œëŠ” ë§¤ìš° ì¢‹ìŒ
- LRU(Least Recently Used): ê°€ì¥ ì˜¤ë«ë™ì•ˆ ì‚¬ìš©ë˜ì§€ ì•Šì€ í˜ì´ì§€ë¥¼ ì œê±°
  - ê³¼ê±°ì˜ ì‚¬ìš© ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ë¯¸ë˜ë¥¼ ì˜ˆì¸¡
  - ì§€ì—­ì„±(locality)ì´ ìˆëŠ” ê²½ìš°, LRUëŠ” Optimalì— ê°€ê¹ê²Œ ë™ì‘í•¨

## FIFO Algorithm (1)
- Reference string: 7, 0, 1, 2, 0, 3, 0, 4, 2, 3, 0, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1
- 3 frames (3 pages can be in memory at a time per process) <br>
 
![image](https://github.com/user-attachments/assets/e3464be4-df17-4185-8bda-5dc83402a69a) <br>
- Beladyâ€™s Anomaly
  - Adding more frames can cause more page faults! (compare FIFO with 3 and 4 frames)
  - frameì„ ë” ì¶”ê°€í•˜ë©´ ì˜¤íˆë ¤ page faultê°€ ì¦ê°€í•  ìˆ˜ ìˆë‹¤! (ì˜ˆ: FIFOì—ì„œ frame ìˆ˜ê°€ 3ê°œì¼ ë•Œì™€ 4ê°œì¼ ë•Œë¥¼ ë¹„êµ)
  - Consider 1, 2, 3, 4, 1, 2, 5, 1, 2, 3, 4, 5 <br>

![image](https://github.com/user-attachments/assets/59a66eb9-a92e-437d-8880-ae8df82f64f1)

## Optimal (OPT) Algorithm
- ê°€ì¥ ì˜¤ë«ë™ì•ˆ ì‚¬ìš©ë˜ì§€ ì•Šì„ í˜ì´ì§€ë¥¼ êµì²´í•œë‹¤.
- ì´ ë°©ì‹ì€ ìì‹ ì˜ ì•Œê³ ë¦¬ì¦˜ì´ ì–¼ë§ˆë‚˜ ì˜ ì‘ë™í•˜ëŠ”ì§€ í‰ê°€í•  ë•Œ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©ëœë‹¤.
- Reference string: 7, 0, 1, 2, 0, 3, 0, 4, 2, 3, 0, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1 <br>

![image](https://github.com/user-attachments/assets/7970a26d-dd1c-484b-93c8-89bb288acc89)

## LRU (Least Recently Used) Algorithm (OPTì™€ ë¹„ìŠ·í•˜ê²Œ í•˜ê¸° ìœ„í•´ ë§Œë“¬)
- ë¯¸ë˜ê°€ ì•„ë‹Œ ê³¼ê±°ì˜ ì •ë³´ë¥¼ í™œìš©í•œë‹¤.
- ê°€ì¥ ì˜¤ë«ë™ì•ˆ ì‚¬ìš©ë˜ì§€ ì•Šì€ í˜ì´ì§€ë¥¼ êµì²´í•œë‹¤.
- Reference string: 7, 0, 1, 2, 0, 3, 0, 4, 2, 3, 0, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1 <br>

![image](https://github.com/user-attachments/assets/78a26860-bc35-48af-aa75-779e054beb48)
- Stack algorithm
  - nê°œì˜ framesì— ìˆëŠ” í˜ì´ì§€ ì§‘í•©ì€ í•­ìƒ n+1ê°œì˜ framesì— ìˆëŠ” í˜ì´ì§€ ì§‘í•©ì˜ ë¶€ë¶„ì§‘í•©ì´ë‹¤.
- LRUì™€ OPTëŠ” Beladyì˜ ì—­ì„¤ì´ ì—†ëŠ” stack algorithmsì˜ ì˜ˆì´ë‹¤.
- êµ¬í˜„ë°©ë²•?
- ë‘ ê°€ì§€ êµ¬í˜„ ë°©ë²•
  - Counter implementation
    - ëª¨ë“  í˜ì´ì§€ í•­ëª©ì— ì¹´ìš´í„°ê°€ ìˆë‹¤. í˜ì´ì§€ê°€ ì°¸ì¡°ë  ë•Œë§ˆë‹¤ clock(ì‹œê°„ ì •ë³´ ê¸°ë¡)ì„ ì¹´ìš´í„°ì— ë³µì‚¬í•œë‹¤.
    - í˜ì´ì§€ë¥¼ êµì²´í•  ë•ŒëŠ” ê°€ì¥ ì‘ì€ ê°’ì„ ê°€ì§„ ì¹´ìš´í„°ë¥¼ ì°¾ëŠ”ë‹¤.
      - í…Œì´ë¸”ì„ ê²€ìƒ‰í•´ì•¼ í•œë‹¤. <br>

![image](https://github.com/user-attachments/assets/c25d8c61-2826-476a-94e0-9742aa3deeb9) <br>
  - Stack implementation
    - page numbersë¥¼ ì´ì¤‘ ì—°ê²° í˜•íƒœì˜ ìŠ¤íƒìœ¼ë¡œ ìœ ì§€í•œë‹¤.
    - í˜ì´ì§€ê°€ ì°¸ì¡°ë˜ë©´
      - ìŠ¤íƒ ë§¨ ìœ„ë¡œ ì´ë™
    - ìµœëŒ€ 6ê°œì˜ pointerë§Œ ë³€ê²½ í•„ìš”
    - í•˜ì§€ë§Œ ê° ì—…ë°ì´íŠ¸ ë¹„ìš©ì´ ë” í¼
    - êµì²´í•  í˜ì´ì§€ë¥¼ ì°¾ê¸° ìœ„í•œ ê²€ìƒ‰ ë¶ˆí•„ìš” <br>

![image](https://github.com/user-attachments/assets/1b544b16-025b-46f6-af38-4915ad5c2c52) <br>
- Stack implementation example <br>

![image](https://github.com/user-attachments/assets/4b2f2c7a-faeb-4c4f-a31b-35047c093ad8)

## LRU Approximations
 â€¢ Basic: make use of hardware support: reference bit (use bit)
 â€¢ Initially, reference bit = 0
 â€¢ When page is accessed, reference bit = 1
 â€¢ Replace any with reference bit = 0 (if one exist)
 â€¢ We do not know the order, however
 â€¢ Additional-Reference Bits Algorithm
 â€¢ Second-Chance Algorithm (Clock Algorithm)
 â€¢ Enhanced Clock Algorithm
 â€¢ Counting-Based Algorithm
- Basic: HW support(ê°„ë‹¨í•œ clock algorithm) â€”> reference bit(ì‚¬ìš© ë¹„íŠ¸) 1bit
  - ì²˜ìŒì—ëŠ” reference bit = 0
  - í˜ì´ì§€ê°€ ì ‘ê·¼ë˜ë©´ reference bit = 1
  - ì£¼ê¸°ì ìœ¼ë¡œ reference bit = 0ìœ¼ë¡œ ì´ˆê¸°í™” í•´ì¤€ë‹¤.
  - reference bitê°€ 0ì¸ í˜ì´ì§€ê°€ ìˆìœ¼ë©´ ê·¸ í˜ì´ì§€ë¥¼ êµì²´ -> 0ì´ ì˜ë¯¸í•˜ëŠ” ë°”ëŠ” <br>
  ì£¼ê¸°ì ì¸ ì´ˆê¸°í™” ì´í›„ í•´ë‹¹ í˜ì´ì§€ì— ì ‘ê·¼ì´ ì—†ì—ˆë‹¤ëŠ” ë§ì´ë‹¤.
    - ë‹¤ë§Œ, êµì²´ ìˆœì„œëŠ” ì•Œ ìˆ˜ ì—†ë‹¤.
- Additional-Reference Bits Algorithm
- Second-Chance Algorithm (Clock Algorithm)
- Enhanced Clock Algorithm
- Counting-Based Algorithm
